# 8. **C++**

## **8.1 Редактор формул**

Редактировать формулы на C++ вы можете во вкладке `Formulas`, которая находится в дереве по пути:

1. Portfolios -> "Название портфеля" -> Formulas;
2. Portfolios -> "Название портфеля" -> "Название инструмента" -> Formulas;

В первом случае будут отображены поля `Trade formula`, `Extra field#1` и `Extra field#2`.
Во втором `Count formula`, `Ratio buy formula`, ``Ratio sell formula`.

В редакторе формул существует возможность тестового выполнения выбранной формулы (кнопка `Test`), при этом на момент вычисления формулы создаётся временная копия портфеля, НО если вы в формуле изменяете значения полей портфеля, и у вас существует портфель с тем же именем, то изменения применятся к этому порфтелю.

## **8.2 Важно**

При написании формул на языке программирования C++ на код накладываются некоторые ограничения:
- Вы пишете только тело соответствующих функций, все функции должны возвращать значение типа `double`.
- Запрещено использование некоторых символов и слов: `\001`, `#nl`, `#tab`.
- Вы можете получить доступ к любому портфелю робота, к инструменту портфеля робота, а также к инструменту биржи, который фигурирует хотя бы в одном из ваших порфтелей.
- Вы можете изменять значения некоторых полей порфтелей и инструментов портфелей. При изменении занчений каких-то полей, вы можете "сломать" работу штатного алгоритма робота, имейте это в виду. В связи с этим для экстренного отключения торговли и выключения всех расчётов по формулам в меню действий с портфелями предусмотрен пункт `Stop formulas`.
- Портфель (структура `portfolio`) содержит методы `data()` и `extra()` которые позволяют получить доступ к словарям, в которые можно сохранять данные между вызовами формул.

**Важно:** если значение поля какой-либо бумаги еще не было получено с биржи или для бумаги с данной биржи нельзя получить значение этого поля, то вы получите 0. Нужно понимать что, например, на пустом стакане вы можете получить 0 в качестве цены бида или оффера, поэтому всегда проверяйте значения на равенство нулю в тех ситуациях, где это критично (например, при делении или при нахождении среднего арифметического бида и оффера).

**Важно:** рекомендуется пользоваться именно даннйо версией `API` формул, т.к. она дает больше возможностей и быстрее работает.

## **8.3. Доступ к биржевым данным по финансовым инструментам**

| **Функция**                                             | **Описание**                                                          |
|---------------------------------------------------------|-----------------------------------------------------------------------|
| struct security get_security(const std::string& s)      | получить инструмент по его SecKey s                                   |
| struct security get_security(const char* s)             | получить инструмент по его SecKey s                                   |
| struct security get_security()                          | получить инструмент, соответствующий главной бумаге текущего портфеля |
| struct security get_security(const security_fields& sf) | получить инструмент, соответствующий заданной бумаге портфеля         |

Методы `security`:

| **Метод**                       | **Описание**                                     |
|---------------------------------|--------------------------------------------------|
| double theor_price()            | расчетная цена, есть только для опционов         |
| double yield_sell()             | доходность, рассчитанная по офферу               |
| double yield_buy()              | доходность, рассчитанная по биду                 |
| double bid()                    | лучшая цена на покупку                           |
| double offer()                  | лучшая цена на продажу                           |
| double exp_date()               | дата экспирации, в формате epoch                 |
| double strike()                 | цена страйк, есть только у опционов              |
| long long offer_depth()         | объем оффера в лотах                             |
| long long bid_depth()           | объем бида в лотах                               |
| double limit_up()               | разрешенный верхний лимит цены                   |
| double limit_down()             | разрешенный нижний лимит цены                    |
| double min_step()               | минимальный шаг цены                             |
| double lot_round()              | количество ценных бумаг в одном стандартном лоте |
| double funding_rate()           | ставка фондирования                              |
| long long funding_time()        | время следующего фондирования в формате epoch    |
| const spb_commons& spb_common() | структура с полями, описанными ниже              |
| order_book orderbook()          | структура с методами, описанными ниже            |

Поля `spb_commons` (названия и описания взяты из документации [СПб биржи](https://ftp.spbexchange.ru/TS/DOCS/MDbinary.pdf)):

| **Название**             | **Тип**   | **Описание**                                          |
|--------------------------|-----------|-------------------------------------------------------|
| price_last               | double    | цена последней сделки                                 |
| price_open               | double    | цена первой сделки за сессию                          |
| price_close              | double    | официальная цена закрытия                             |
| price_high               | double    | сделка с максимальной ценой                           |
| price_low                | double    | сделка с минимальной ценой                            |
| price_auction_close_prev | double    | цена аукциона закрытия предыдущего дня                |
| price_halt               | double    | цена для определения приостановок                     |
| price_official_min_time  | long long | время последнего изменения минимальной текущей цены   |
| price_indicative         | double    | текущая цена рынка                                    |
| price_close_prev         | double    | официальная цена закрытия предыдущего дня             |
| price_official           | double    | официальная цена онлайн (текущая цена)                |
| price_vwap_day_prev      | double    | средневзвешенная цена основной сессии предыдущего дня |
| price_vwap_day           | double    | средневзвешенная цена основной сессии текущего дня    |
| price_current            | double    | текущая котировка                                     |
| price_average            | double    | средневзвешенная цена                                 |
| time_last                | long long | время последней сделки                                |
| price_prev_period_close  | double    | цена последней сделки предыдущего дня                 |

[Пример СДЕЛАТЬ ССЫЛКУ!!!]() доступа к полям структуры `spb_commons`:

Методы `order_book`:

| Метод                  | Описание                                                                                                                                                         |
|------------------------|------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| bool is_available()    | доступен ли в данный момент для данной бумаги стакан                                                                                                             |
| bool has_next_bid()    | есть ли еще бид в списке бидов                                                                                                                                   |
| bool has_next_offer()  | есть ли еще оффер в списке офферов                                                                                                                               |
| std::pair next_bid()   | получить текущий бид в формате пара: цена + объем (если его нет, вы получите исключение std::out_of_range) и передвинуть указатель на следующий бид в списке     |
| std::pair next_offer() | получить текущий оффер в формате пара: цена + объем (если его нет, вы получите исключение std::out_of_range) и передвинуть указатель на следующий оффер в списке |